{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Postal DNSBL Monitor Structured Logging Schema",
  "description": "JSON schema for structured logs emitted by the DNSBL monitoring CronJob. Logs are consumed by Kubernetes log aggregation systems (ELK, Splunk, CloudWatch).",
  
  "definitions": {
    "per_ip_log": {
      "type": "object",
      "description": "Log entry for each IP address checked during job run (FR-028)",
      "required": ["timestamp", "job_run_id", "ip", "decision", "db_changes", "jira_action"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when IP check completed",
          "example": "2025-12-17T10:30:45.123Z"
        },
        "job_run_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for this job execution (correlation ID)",
          "example": "550e8400-e29b-41d4-a716-446655440000"
        },
        "ip": {
          "type": "string",
          "pattern": "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$",
          "description": "IPv4 address checked",
          "example": "203.0.113.45"
        },
        "listed_zones": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "DNSBL zone domain name"
          },
          "description": "List of DNSBL zones where IP returned LISTED (A record response)",
          "example": ["zen.spamhaus.org", "bl.spamcop.net"]
        },
        "unknown_zones": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "DNSBL zone domain name"
          },
          "description": "List of DNSBL zones that returned UNKNOWN (timeout, SERVFAIL, etc.)",
          "example": ["dnsbl.sorbs.net"]
        },
        "decision": {
          "type": "string",
          "enum": ["LISTED", "CLEAN"],
          "description": "Final listing decision for this IP (LISTED if ≥1 zone returned LISTED, CLEAN otherwise)",
          "example": "LISTED"
        },
        "db_changes": {
          "type": "boolean",
          "description": "Whether database was updated for this IP (false for idempotent no-ops)",
          "example": true
        },
        "jira_action": {
          "type": "string",
          "enum": ["created_issue", "updated_issue", "no_action"],
          "description": "Action taken in Jira for this IP",
          "example": "created_issue"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Time taken to process this IP in milliseconds (DNS queries + DB update + Jira action)",
          "example": 1234
        },
        "level": {
          "type": "string",
          "enum": ["DEBUG", "INFO", "WARNING", "ERROR"],
          "description": "Log level (typically INFO for successful IP checks)",
          "example": "INFO"
        }
      }
    },
    
    "job_summary_log": {
      "type": "object",
      "description": "Summary log emitted at job completion (FR-031)",
      "required": ["timestamp", "job_run_id", "total_ips", "listed", "cleaned", "unchanged", "jira_created", "jira_updated", "dns_failures", "duration_sec"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when job completed",
          "example": "2025-12-17T10:35:00.456Z"
        },
        "job_run_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for this job execution (same as per-IP logs)",
          "example": "550e8400-e29b-41d4-a716-446655440000"
        },
        "total_ips": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of IP addresses checked",
          "example": 1000
        },
        "listed": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of IPs found listed on ≥1 DNSBL",
          "example": 5
        },
        "cleaned": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of IPs that were previously listed but are now clean",
          "example": 2
        },
        "unchanged": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of IPs with no state change (idempotent no-ops)",
          "example": 993
        },
        "jira_created": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of new Jira issues created",
          "example": 3
        },
        "jira_updated": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of existing Jira issues updated (comments added)",
          "example": 4
        },
        "dns_failures": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of DNS queries that returned UNKNOWN (across all IPs and zones)",
          "example": 12
        },
        "duration_sec": {
          "type": "number",
          "minimum": 0,
          "description": "Total job execution time in seconds",
          "example": 285.4
        },
        "level": {
          "type": "string",
          "enum": ["INFO"],
          "description": "Log level (always INFO for job summary)",
          "example": "INFO"
        },
        "message": {
          "type": "string",
          "description": "Human-readable summary message",
          "example": "Job completed successfully"
        }
      }
    },
    
    "dns_failure_log": {
      "type": "object",
      "description": "Log entry for individual DNS query failures (FR-029)",
      "required": ["timestamp", "job_run_id", "ip", "zone", "error_type"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when DNS query failed",
          "example": "2025-12-17T10:30:42.789Z"
        },
        "job_run_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for this job execution",
          "example": "550e8400-e29b-41d4-a716-446655440000"
        },
        "ip": {
          "type": "string",
          "pattern": "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$",
          "description": "IPv4 address being queried",
          "example": "203.0.113.45"
        },
        "zone": {
          "type": "string",
          "description": "DNSBL zone that failed to respond",
          "example": "dnsbl.sorbs.net"
        },
        "query_type": {
          "type": "string",
          "enum": ["A"],
          "description": "DNS query type (always A for DNSBL checks)",
          "example": "A"
        },
        "error_type": {
          "type": "string",
          "enum": ["Timeout", "SERVFAIL", "NoAnswer", "NoNameservers", "DNSException"],
          "description": "Type of DNS error encountered",
          "example": "Timeout"
        },
        "error_message": {
          "type": "string",
          "description": "Detailed error message from dnspython",
          "example": "The DNS operation timed out after 5.0 seconds"
        },
        "timeout_value": {
          "type": "integer",
          "description": "DNS timeout configured for this query (seconds)",
          "example": 5
        },
        "level": {
          "type": "string",
          "enum": ["WARNING"],
          "description": "Log level (WARNING for non-fatal DNS failures)",
          "example": "WARNING"
        }
      }
    },
    
    "fatal_error_log": {
      "type": "object",
      "description": "Log entry for fatal errors that cause job exit with non-zero code (FR-030)",
      "required": ["timestamp", "job_run_id", "error_type", "error_message"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when fatal error occurred",
          "example": "2025-12-17T10:30:10.123Z"
        },
        "job_run_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for this job execution",
          "example": "550e8400-e29b-41d4-a716-446655440000"
        },
        "error_type": {
          "type": "string",
          "enum": ["DatabaseUnreachable", "JiraAuthenticationFailure", "ConfigurationError"],
          "description": "Type of fatal error",
          "example": "DatabaseUnreachable"
        },
        "error_message": {
          "type": "string",
          "description": "Detailed error message with troubleshooting context",
          "example": "Failed to connect to PostgreSQL at mysql.postal.svc.cluster.local:3306 - connection refused"
        },
        "exit_code": {
          "type": "integer",
          "minimum": 1,
          "description": "Exit code that will be returned (non-zero for fatal errors)",
          "example": 1
        },
        "level": {
          "type": "string",
          "enum": ["ERROR"],
          "description": "Log level (always ERROR for fatal errors)",
          "example": "ERROR"
        },
        "stack_trace": {
          "type": "string",
          "description": "Python stack trace for debugging (optional)",
          "example": "Traceback (most recent call last):\n  File ..."
        }
      }
    }
  },
  
  "oneOf": [
    { "$ref": "#/definitions/per_ip_log" },
    { "$ref": "#/definitions/job_summary_log" },
    { "$ref": "#/definitions/dns_failure_log" },
    { "$ref": "#/definitions/fatal_error_log" }
  ],
  
  "examples": [
    {
      "description": "Per-IP log - IP becomes listed",
      "data": {
        "timestamp": "2025-12-17T10:30:45.123Z",
        "job_run_id": "550e8400-e29b-41d4-a716-446655440000",
        "ip": "203.0.113.45",
        "listed_zones": ["zen.spamhaus.org"],
        "unknown_zones": [],
        "decision": "LISTED",
        "db_changes": true,
        "jira_action": "created_issue",
        "duration_ms": 1234,
        "level": "INFO"
      }
    },
    {
      "description": "Per-IP log - IP remains clean (no-op)",
      "data": {
        "timestamp": "2025-12-17T10:30:46.456Z",
        "job_run_id": "550e8400-e29b-41d4-a716-446655440000",
        "ip": "198.51.100.10",
        "listed_zones": [],
        "unknown_zones": [],
        "decision": "CLEAN",
        "db_changes": false,
        "jira_action": "no_action",
        "duration_ms": 234,
        "level": "INFO"
      }
    },
    {
      "description": "DNS failure log - Timeout",
      "data": {
        "timestamp": "2025-12-17T10:30:42.789Z",
        "job_run_id": "550e8400-e29b-41d4-a716-446655440000",
        "ip": "203.0.113.45",
        "zone": "dnsbl.sorbs.net",
        "query_type": "A",
        "error_type": "Timeout",
        "error_message": "The DNS operation timed out after 5.0 seconds",
        "timeout_value": 5,
        "level": "WARNING"
      }
    },
    {
      "description": "Job summary log - Successful completion",
      "data": {
        "timestamp": "2025-12-17T10:35:00.456Z",
        "job_run_id": "550e8400-e29b-41d4-a716-446655440000",
        "total_ips": 1000,
        "listed": 5,
        "cleaned": 2,
        "unchanged": 993,
        "jira_created": 3,
        "jira_updated": 4,
        "dns_failures": 12,
        "duration_sec": 285.4,
        "level": "INFO",
        "message": "Job completed successfully"
      }
    },
    {
      "description": "Fatal error log - Database unreachable",
      "data": {
        "timestamp": "2025-12-17T10:30:10.123Z",
        "job_run_id": "550e8400-e29b-41d4-a716-446655440000",
        "error_type": "DatabaseUnreachable",
        "error_message": "Failed to connect to PostgreSQL at mysql.postal.svc.cluster.local:3306 - connection refused",
        "exit_code": 1,
        "level": "ERROR"
      }
    }
  ],
  
  "notes": [
    "All timestamps are in ISO 8601 format with UTC timezone",
    "job_run_id is consistent across all logs for a single job execution (use for correlation in log aggregation)",
    "Log levels: DEBUG < INFO < WARNING < ERROR",
    "Fatal errors (DatabaseUnreachable, JiraAuthenticationFailure, ConfigurationError) cause exit code 1",
    "Non-fatal errors (DNS failures) log at WARNING level but job continues",
    "Per-IP logs are emitted synchronously after each IP is processed",
    "Job summary log is emitted once at the end of job execution",
    "Logs are written to stdout for Kubernetes log collection"
  ]
}
